# Out-of-distribution Detection with Posterior Sampling
This project is for the paper: Out-of-distribution Detection with Posterior Sampling. Some parts of the codebase are adapted from [ODIN](https://github.com/facebookresearch/odin), [Outlier Exposure](https://github.com/hendrycks/outlier-exposure), [Deep Mahalanobis Detector](https://github.com/pokaxpoka/deep_Mahalanobis_detector) and [NTOM](https://github.com/jfc43/informative-outlier-mining).

## Required Packages

The following packages are required to be installed:

- [PyTorch](https://pytorch.org/)
- [Scipy](https://github.com/scipy/scipy)
- [Numpy](http://www.numpy.org/)
- [Sklearn](https://scikit-learn.org/stable/)

Our experiments are conducted on Ubuntu Linux 20.04 with Python 3.8.

## Method Overview

![architecture](framework.pdf)


## In-distribution and Auxiliary Outlier Datasets

- In-distribution training set:
  - [CIFAR](https://www.cs.toronto.edu/~kriz/cifar.html): included in PyTorch.

* Auxiliary outlier training set:

  * [80 Million Tiny Images](https://groups.csail.mit.edu/vision/TinyImages/): to download **80 Million Tiny Images** dataset. In the **root** directory, run

    ```
    cd datasets/unlabeled_datasets/80M_Tiny_Images
    wget http://horatio.cs.nyu.edu/mit/tiny/data/tiny_images.bin
    ```

    Note that although we provide this option here for potential extension in the future, we do not report the results with 80 Million Tiny Images in our main paper as it has been officially taken down due to ["derogatory terms as categories and offensive images"](https://groups.csail.mit.edu/vision/TinyImages/).

  * ImageNet-RC (Downsampled ImageNet Datasets](https://patrykchrabaszcz.github.io/Imagenet32/): we use the ImageNet64x64, which can be downloaded from [ImageNet Website](http://image-net.org/download-images). After downloading it, place it in this directory: `datasets/unlabeled_datasets/ImageNet`. 
## Out-of-distribution Test Datasets

We provide links and instructions to download each dataset:

* [SVHN](http://ufldl.stanford.edu/housenumbers/test_32x32.mat): download it and place it in the folder of `datasets/ood_datasets/svhn`. Then run `python select_svhn_data.py` to generate test subset.
* [Textures](https://www.robots.ox.ac.uk/~vgg/data/dtd/download/dtd-r1.0.1.tar.gz): download it and place it in the folder of `datasets/ood_datasets/dtd`.
* [Places365](http://data.csail.mit.edu/places/places365/test_256.tar): download it and place it in the folder of `datasets/ood_datasets/places365/test_subset`. We randomly sample 10,000 images from the original test dataset.
* [LSUN-C](https://www.dropbox.com/s/fhtsw1m3qxlwj6h/LSUN.tar.gz): download it and place it in the folder of `datasets/ood_datasets/LSUN`.
* [LSUN-R](https://www.dropbox.com/s/moqh2wh8696c3yl/LSUN_resize.tar.gz): download it and place it in the folder of `datasets/ood_datasets/LSUN_resize`.
* [iSUN](https://www.dropbox.com/s/ssz7qxfqae0cca5/iSUN.tar.gz): download it and place it in the folder of `datasets/ood_datasets/iSUN`.

For example, run the following commands in the **root** directory to download **LSUN-C**:
```
cd datasets/ood_datasets
wget https://www.dropbox.com/s/fhtsw1m3qxlwj6h/LSUN.tar.gz
tar -xvzf LSUN.tar.gz
```

## Codebase Overview

* `select_svhn_data.py`: select SVHN test data.
* `train_poem.py`: train with the posterior sampling-based outlier mining framework.
* `get_score.py`: evaulate OOD detection performance of Energy-based methods (i.e. Liu et al. 2020 and POEM) and save results.
* `get_results.py`: present the false positive rate (FPR95), AUROC, AUPR, the detection error rate, etc based on results generated by `get_score.py`.

We will provide the scripts to train and evaluate other methods in the public version.

## Quick Start and Model Checkpoints

Here we provide a sample of commands for training on CIFAR-10 with DenseNet:

```python
# train an POEM model
python train_poem.py --name POEM --in-dataset CIFAR-10 --auxiliary-dataset imagenet --epochs 100 --model-arch densenet
```

**Checkpoints:** We also provide several checkpoints for trained model [here](https://www.dropbox.com/sh/tsqwbob249gouzy/AABS21uLcB1TdwoHxMQpOXpia?dl=0). For example, to test POEM trained for 80 epochs on CIFAR-100, put the corresponding checkpoint at `./checkpoints/CIFAR-100/POEM_Sample_1/checkpoint_80.pth.tar`. We will provide more checkpoints with other methods in the public version.

Here we provide the commands to evaluate the OOD detection performance of POEM:

```python
# Generate evaluation results for POEM:
python get_score.py --name POEM --in-dataset CIFAR-10 --model-arch densenet --test_epochs 100

# Present OOD detection metrics based on results:
python get_results.py --name POEM  --in-dataset CIFAR-10 --test_epochs 100
```

## Issues and further discussions
Please create an issue for code-related questions. For further discussions, free feel to drop an email at ming5@wisc.edu.
